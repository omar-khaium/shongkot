name: Frontend CI/CD

on:
  push:
    branches: [ main, mobile ]
    paths:
      - 'mobile/**'
      - '.github/workflows/frontend-cicd.yml'
  pull_request:
    branches: [ main, mobile ]
    paths:
      - 'mobile/**'
      - '.github/workflows/frontend-cicd.yml'

env:
  FLUTTER_VERSION: '3.35.3'
  
jobs:
  analyze-and-test:
    name: Analyze and Test Flutter App
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      working-directory: ./mobile
      
    - name: Format code
      run: dart format .
      working-directory: ./mobile
    
    - name: Generate firebase_options.dart
      uses: ./.github/actions/generate-firebase-options
      with:
        firebase-project-id: ${{ secrets.FIREBASE_PROJECT_ID }}
        firebase-token: ${{ secrets.FIREBASE_TOKEN }}
        working-directory: ./mobile
        output-path: lib/firebase_options.dart
        platforms: android
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
    - name: Analyze code
      run: flutter analyze
      working-directory: ./mobile
      
    - name: Run unit tests
      run: flutter test --coverage
      working-directory: ./mobile
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./mobile/coverage/lcov.info
        flags: frontend
        name: frontend-coverage
        fail_ci_if_error: false
        
    - name: Run widget tests
      run: flutter test test/widget
      working-directory: ./mobile
      continue-on-error: true
      
  integration-test:
    if: false
    name: Integration Tests
    runs-on: macos-latest
    needs: analyze-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      working-directory: ./mobile
      
    - name: Setup iOS Simulator
      run: |
        xcrun simctl list devices
        DEVICE_ID=$(xcrun simctl create TestiPhone com.apple.CoreSimulator.SimDeviceType.iPhone-14)
        xcrun simctl boot $DEVICE_ID
        echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV
        
    - name: Run integration tests
      run: flutter test integration_test
      working-directory: ./mobile
      continue-on-error: true
      
  build-android:
    name: Build Android APK & AAB
    runs-on: ubuntu-latest
    needs: analyze-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '21'
        cache: 'gradle'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      working-directory: ./mobile

    - name: Generate firebase_options.dart
      uses: ./.github/actions/generate-firebase-options
      with:
        firebase-project-id: ${{ secrets.FIREBASE_PROJECT_ID }}
        firebase-token: ${{ secrets.FIREBASE_TOKEN }}
        working-directory: ./mobile
        output-path: lib/firebase_options.dart
        platforms: android
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
    - name: Setup signing keys
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # Only setup signing if secrets are available
        if [ -n "$KEYSTORE_BASE64" ]; then
          echo "Setting up release signing..."
          # Decode keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          
          # Create key.properties
          cat > android/key.properties << EOF
        storePassword=$KEYSTORE_PASSWORD
        keyPassword=$KEY_PASSWORD
        keyAlias=$KEY_ALIAS
        storeFile=../app/key.jks
        EOF
          echo "Release signing configured"
        else
          echo "No signing secrets found, using debug signing"
        fi
      working-directory: ./mobile
      
    - name: Build APK
      run: flutter build apk --release
      working-directory: ./mobile
      
    - name: Build App Bundle
      run: flutter build appbundle --release
      working-directory: ./mobile
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: mobile/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30
        
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: mobile/build/app/outputs/bundle/release/app-release.aab
        retention-days: 30
        
  build-ios:
    if: false
    name: Build iOS IPA
    runs-on: macos-latest
    needs: analyze-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      working-directory: ./mobile
      
    - name: Build iOS (no codesign)
      run: flutter build ios --release --no-codesign
      working-directory: ./mobile
      continue-on-error: true
      
  deploy-firebase:
    name: Deploy to Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [build-android]
    if: github.event_name == 'push' && github.ref == 'refs/heads/mobile'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download APK artifact
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: ./artifacts
        
    - name: Download AAB artifact
      uses: actions/download-artifact@v4
      with:
        name: android-aab
        path: ./artifacts
        
    - name: Generate Release Notes
      id: release_notes
      run: |
        cat > release-notes.txt << EOF
        ðŸš€ Shongkot Emergency Responder - Build #${{ github.run_number }}
        
        ðŸ“± Version: 1.0.0+${{ github.run_number }}
        ðŸ”¨ Build: ${{ github.run_number }}
        ðŸ“ Commit: ${{ github.sha }}
        ðŸŒ¿ Branch: ${{ github.ref_name }}
        ðŸ‘¤ Author: ${{ github.actor }}
        ðŸ“… Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        
        ðŸ“¦ What's New:
        - In-app update support enabled
        - Automatic update notifications
        - Bug fixes and improvements
        
        âš¡ Features:
        - Emergency SOS button
        - Real-time location tracking
        - Contact notification system
        
        ðŸ”— Links:
        - Repository: ${{ github.server_url }}/${{ github.repository }}
        - Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
        
        âš ï¸ Note: This is a proprietary build. Unauthorized distribution is prohibited.
        EOF
        cat release-notes.txt
        
    - name: Deploy to Firebase App Distribution
      id: firebase_deploy
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_CREDENTIALS }}
        file: ./artifacts/app-release.apk
        releaseNotesFile: release-notes.txt
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-build.${{ github.run_number }}
        name: Release v1.0.0 Build ${{ github.run_number }}
        body_path: release-notes.txt
        draft: false
        prerelease: false
        files: |
          ./artifacts/app-release.apk
          ./artifacts/app-release.aab
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Save Firebase Distribution Info
      run: |
        mkdir -p firebase-dist-info
        cat > firebase-dist-info/distribution-info.json << EOF
        {
          "build_number": "${{ github.run_number }}",
          "version": "1.0.0+${{ github.run_number }}",
          "commit_sha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "build_date": "$(date -u +'%Y-%m-%d %H:%M:%S UTC')",
          "firebase_app_id": "${{ secrets.FIREBASE_APP_ID }}",
          "distribution_type": "public",
          "in_app_updates": "enabled",
          "download_link": "https://appdistribution.firebase.google.com/testerapps/${{ secrets.FIREBASE_APP_ID }}"
        }
        EOF
        cat firebase-dist-info/distribution-info.json
        
    - name: Upload Distribution Info
      uses: actions/upload-artifact@v4
      with:
        name: firebase-distribution-info
        path: firebase-dist-info/
        retention-days: 90
        
    - name: Comment on PR with download link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const buildNum = '${{ github.run_number }}';
          const firebaseLink = 'https://appdistribution.firebase.google.com/testerapps/${{ secrets.FIREBASE_APP_ID }}';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âœ… Build Successful!\n\n` +
                  `**Version:** 1.0.0+${buildNum}\n` +
                  `**Build:** #${buildNum}\n\n` +
                  `### ðŸ“± Download\n` +
                  `APK has been uploaded to Firebase App Distribution with **in-app updates enabled**.\n\n` +
                  `ðŸ”— [Download from Firebase](${firebaseLink}) (Public - anyone with the link)\n\n` +
                  `### âš¡ In-App Updates\n` +
                  `âœ… Automatic update prompts enabled for existing users\n` +
                  `âœ… Seamless update delivery through Firebase\n\n` +
                  `### ðŸ“¦ Artifacts\n` +
                  `- APK: Available in workflow artifacts\n` +
                  `- AAB: Available in workflow artifacts\n` +
                  `- Distribution Info: Available in workflow artifacts\n\n` +
                  `**Note:** This build is publicly accessible. Users need Firebase App Tester app to receive automatic updates.`
          })
          
  update-readme-main:
    name: Update README with Distribution Links (Main Branch Only)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update README with Distribution Link
      run: |
        set -euo pipefail
        
        # Get latest release info from GitHub API
        LATEST_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest")
        RELEASE_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // "v1.0.0-build.1"')
        RELEASE_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url // "https://github.com/${{ github.repository }}/releases/latest"')
        RELEASE_DATE=$(echo "$LATEST_RELEASE" | jq -r '.published_at // "N/A"' | cut -d'T' -f1)
        
        # Firebase link
        FIREBASE_LINK="https://appdistribution.firebase.google.com/testerapps/${{ secrets.FIREBASE_APP_ID }}"
        
        # Backup README
        cp README.md README.md.bak
        
        # Create mobile app section
        {
          echo "## ðŸ“± Latest Mobile App Version"
          echo ""
          echo "**Version:** ${RELEASE_TAG}  "
          echo "**Release Date:** ${RELEASE_DATE}  "
          echo "**Platform:** Android (iOS coming soon)  "
          echo "**Distribution:** Firebase App Distribution"
          echo ""
          echo "### Download Links"
          echo ""
          echo "- **Firebase App Distribution:** [Download Latest APK](${FIREBASE_LINK}) (Public - anyone with the link)"
          echo "- **GitHub Releases:** [${RELEASE_TAG}](${RELEASE_URL})"
          echo ""
          echo "### In-App Updates"
          echo ""
          echo "âœ… **Automatic Updates Enabled**"
          echo "- Users with previous versions will receive update prompts"
          echo "- Updates are delivered through Firebase App Distribution"
          echo "- No manual download required for existing users"
          echo ""
          echo "### Features"
          echo ""
          echo "- Emergency SOS button with one-tap activation"
          echo "- Real-time GPS location tracking"
          echo "- Automatic emergency contact notifications"
          echo "- Nearby responders finder"
          echo ""
          echo "---"
          echo ""
        } > mobile_section.md
        
        # Check if mobile app section already exists
        if grep -q "## ðŸ“± Latest Mobile App Version" README.md; then
          # Replace existing mobile app section
          awk '
            /## ðŸ“± Latest Mobile App Version/ {
              system("cat mobile_section.md")
              skip=1
              next
            }
            /^---$/ && skip {
              skip=0
              next
            }
            !skip
          ' README.md > README.md.new
          mv README.md.new README.md
        else
          # Insert after deployment section (after first ---)
          awk '
            BEGIN { found=0 }
            /^---$/ && !found {
              print
              print ""
              system("cat mobile_section.md")
              found=1
              next
            }
            { print }
          ' README.md > README.md.new
          mv README.md.new README.md
        fi
        
        # Clean up
        rm mobile_section.md
    
    - name: Commit and push README updates
      run: |
        set -euo pipefail
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if git diff --quiet README.md; then
          echo "No changes to README.md"
          exit 0
        fi
        
        git add README.md
        git commit -m "docs: update README with mobile app distribution info"
        
        # Pull latest changes and rebase before pushing to avoid conflicts
        echo "Pulling latest changes from main..."
        git pull --rebase origin main || {
          echo "::warning::Rebase failed, attempting to abort and retry..."
          git rebase --abort || true
          git pull --rebase origin main
        }
        
        echo "Pushing changes to main..."
        git push origin HEAD:main
